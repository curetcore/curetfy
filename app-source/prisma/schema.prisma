// Curetfy - COD Form
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Shopify Session Storage (required by shopify-app-remix)
model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@index([shop])
}

// Shop Configuration
model Shop {
  id                  String   @id @default(cuid())
  shopDomain          String   @unique

  // ==========================================
  // WHATSAPP CONFIGURATION
  // ==========================================
  whatsappNumber      String?
  messageTemplate     String?  @default("Hola, realicé un pedido el cual me gustaría que sea entregado tomando en cuenta los siguientes datos.\n\nNumero de orden: {order_number}\nTotal de la compra: {order_total}\nLo que compré fue: {products_summary_with_quantity}\n\nPersona autorizada de recibir:\nNombre: {first_name} {last_name}\nWhatsApp: {phone}\nCorreo electronico: {email}\n\nDirección de entrega:\n{address}, {province}\n\nAgradezco su pronta atención y confirmación del envío.\n\nSaludos cordiales,\n\n{first_name} {last_name}")

  // Redirect options after order: "shopify" | "custom" | "whatsapp"
  redirectType        String   @default("whatsapp")
  customRedirectUrl   String?  // URL for custom redirect

  // ==========================================
  // SHOPIFY ORDER CONFIGURATION
  // ==========================================
  orderTagPrefix      String   @default("cod-form")
  orderTags           String[] @default(["pago-contraentrega", "curetfy"])
  createDraftOrder    Boolean  @default(true)
  orderNote           String?  @default("Pedido creado via Curetfy COD Form")

  // ==========================================
  // ORDER OPTIONS
  // ==========================================
  useCodPaymentMethod     Boolean  @default(true)   // Create orders with COD payment method
  saveUtmParams           Boolean  @default(true)   // Save UTM params in order additional details

  // ==========================================
  // FORM OPTIONS
  // ==========================================
  disableAutoDiscounts    Boolean  @default(false)  // Disable Shopify auto discounts in COD form
  disableAutocomplete     Boolean  @default(false)  // Disable autocomplete in COD form
  removeLeadingZeroPhone  Boolean  @default(false)  // Remove leading 0 from phone numbers
  addCodFormTag           Boolean  @default(true)   // Add curetfy_cod_form tag to orders

  // ==========================================
  // FORM LABELS (Editable)
  // ==========================================
  labelName           String   @default("Nombre completo")
  labelPhone          String   @default("Teléfono / WhatsApp")
  labelEmail          String   @default("Email (opcional)")
  labelAddress        String   @default("Dirección de entrega")
  labelCity           String   @default("Ciudad")
  labelProvince       String   @default("Provincia / Estado")
  labelPostalCode     String   @default("Código postal")
  labelNotes          String   @default("Notas del pedido")
  labelQuantity       String   @default("Cantidad")

  // ==========================================
  // FORM PLACEHOLDERS (Editable)
  // ==========================================
  placeholderName     String   @default("Tu nombre")
  placeholderPhone    String   @default("+1 555-123-4567")
  placeholderEmail    String   @default("correo@ejemplo.com")
  placeholderAddress  String   @default("Calle, número, sector...")
  placeholderCity     String   @default("Tu ciudad")
  placeholderNotes    String   @default("Instrucciones especiales...")
  placeholderPostal   String   @default("10101")

  // ==========================================
  // FORM FIELDS VISIBILITY
  // ==========================================
  showEmail           Boolean  @default(false)
  showCity            Boolean  @default(true)
  showProvince        Boolean  @default(true)
  showPostalCode      Boolean  @default(false)
  showNotes           Boolean  @default(true)
  showQuantity        Boolean  @default(true)

  // ==========================================
  // FORM FIELDS REQUIRED
  // ==========================================
  requireEmail        Boolean  @default(false)
  requireCity         Boolean  @default(false)
  requireProvince     Boolean  @default(true)
  requirePostalCode   Boolean  @default(false)
  requireNotes        Boolean  @default(false)

  // ==========================================
  // MODAL CUSTOMIZATION
  // ==========================================
  formTitle           String   @default("Completa tu pedido")
  formSubtitle        String?  @default("Ingresa tus datos para recibir tu pedido")
  submitButtonText    String   @default("Enviar pedido por WhatsApp")
  submitButtonColor   String   @default("#25D366")
  modalHeaderColor    String   @default("#000000")
  modalHeaderTextColor String  @default("#ffffff")
  modalAccentColor    String   @default("#25D366")
  showProductImage    Boolean  @default(true)
  showProductPrice    Boolean  @default(true)

  // ==========================================
  // FIELD ORDERING & CUSTOMIZATION
  // ==========================================
  fieldOrder          Json?    @default("[\"name\", \"phone\", \"email\", \"address\", \"city\", \"province\", \"postalCode\", \"notes\", \"quantity\"]")

  // ==========================================
  // CUSTOM FIELDS (Dynamic form builder)
  // ==========================================
  // Types: text, textarea, select, radio, checkbox, date, number, link_button, image, heading
  // Structure: [{ id, type, label, placeholder?, options?, required?, url?, imageUrl? }]
  customFields        Json?    @default("[]")

  // ==========================================
  // CUSTOM CONTENT (Images, HTML, Liquid)
  // ==========================================
  customImageUrl      String?  // Custom image URL to display
  customImagePosition String   @default("none") // none, top, bottom, after_product
  customHtmlTop       String?  // Custom HTML at top of form
  customHtmlBottom    String?  // Custom HTML at bottom of form (before submit)
  customCss           String?  // Custom CSS styles

  // ==========================================
  // MODAL OPTIONS
  // ==========================================
  hideCloseButton     Boolean  @default(false)  // Hide the X close button
  hideFieldLabels     Boolean  @default(false)  // Hide labels, show only placeholders
  enableRTL           Boolean  @default(false)  // Right-to-left support for Arabic
  fullscreenMobile    Boolean  @default(true)   // Fullscreen modal on mobile devices

  // ==========================================
  // SHIPPING RATES
  // ==========================================
  enableShipping       Boolean  @default(false)  // Enable shipping rates
  shippingSource       String   @default("custom") // "custom" or "shopify"
  customShippingRates  Json?    // Custom shipping rates: [{name, price, deliveryDays, provinces}]

  // Free Shipping
  freeShippingEnabled   Boolean  @default(false)
  freeShippingThreshold String   @default("2000")
  freeShippingLabel     String   @default("Envío gratis")

  // Store Pickup
  enablePickup          Boolean  @default(false)
  pickupName            String   @default("Recoger en tienda")
  pickupAddress         String?
  pickupInstructions    String?

  // ==========================================
  // SUCCESS/ERROR MESSAGES
  // ==========================================
  successTitle        String   @default("¡Pedido enviado!")
  successMessage      String   @default("Te redirigiremos a WhatsApp para confirmar tu pedido.")
  errorTitle          String   @default("Error")
  errorMessage        String   @default("Hubo un problema al procesar tu pedido. Intenta de nuevo.")

  // ==========================================
  // COUNTRY/REGION CONFIGURATION
  // ==========================================
  countries           String[] @default([])
  defaultCountry      String   @default("")
  provincesConfig     Json?    // Custom provinces per country

  // ==========================================
  // PRODUCT SETTINGS
  // ==========================================
  enabledProducts     String[] @default([])
  enabledCollections  String[] @default([])
  enableAllProducts   Boolean  @default(true)

  // ==========================================
  // VISIBILITY SETTINGS
  // ==========================================
  formEnabled              Boolean  @default(true)   // Master on/off toggle
  enableOnProductPages     Boolean  @default(true)   // Show on product pages
  enableOnCartPage         Boolean  @default(false)  // Show on cart page

  // Cart page options
  hideCartBuyNowButton     Boolean  @default(false)  // Hide Buy Now in cart

  // Product page options
  productButtonAction      String   @default("current") // "current" or "current_plus_cart"
  hideAddToCartButton      Boolean  @default(false)  // Hide Add to Cart button
  hideProductBuyNowButton  Boolean  @default(false)  // Hide Buy Now on product pages

  // Other pages
  disableOnHomePage        Boolean  @default(false)  // Disable on home page
  disableOnCollectionPages Boolean  @default(false)  // Disable on collection pages

  // ==========================================
  // LIMITS SETTINGS
  // ==========================================
  limitToSpecificProducts     Boolean  @default(false)  // Only show for specific products
  limitToSpecificCollections  Boolean  @default(false)  // Only show for specific collections
  excludeProducts             Boolean  @default(false)  // Exclude specific products
  excludeCollections          Boolean  @default(false)  // Exclude specific collections
  excludedProducts            String[] @default([])     // List of excluded product IDs
  excludedCollections         String[] @default([])     // List of excluded collection IDs
  limitToCountries            Boolean  @default(false)  // Only show for specific countries
  limitedCountries            String[] @default([])     // List of allowed country codes
  orderMinimum                Decimal? @db.Decimal(10, 2) // Minimum order total
  orderMaximum                Decimal? @db.Decimal(10, 2) // Maximum order total (null = no limit)

  // ==========================================
  // COD FEE (Cash on Delivery)
  // ==========================================
  enableCodFee        Boolean  @default(false)
  codFeeType          String   @default("fixed") // "fixed" or "percentage"
  codFeeAmount        String   @default("0")
  codFeeLabel         String   @default("Cargo por pago contra entrega")

  // ==========================================
  // ORDER LIMITS (enhanced)
  // ==========================================
  enableMinOrder      Boolean  @default(false)
  minOrderAmount      String   @default("0")
  minOrderMessage     String   @default("El monto mínimo de compra es {monto}")
  enableMaxOrder      Boolean  @default(false)
  maxOrderAmount      String   @default("0")
  maxOrderMessage     String   @default("El monto máximo de compra es {monto}")

  // ==========================================
  // TERMS AND CONDITIONS
  // ==========================================
  enableTerms         Boolean  @default(false)
  termsText           String   @default("Acepto los términos y condiciones")
  termsUrl            String?
  termsRequired       Boolean  @default(true)

  // ==========================================
  // ORDER SEQUENCE (for atomic order numbering)
  // ==========================================
  orderSequence       Int      @default(0)  // Auto-incrementing sequence for order numbers

  // ==========================================
  // BLOCKED PROVINCES
  // ==========================================
  enableBlockedProvinces Boolean  @default(false)
  blockedProvinces       String[] @default([])
  blockedProvinceMessage String   @default("Lo sentimos, no realizamos envíos a esta provincia")

  // ==========================================
  // ADVANCED SETTINGS
  // ==========================================
  autoRedirectWhatsApp Boolean @default(true)
  redirectDelay       Int      @default(2000) // milliseconds
  enableAnalytics     Boolean  @default(true)
  enablePixel         Boolean  @default(false)
  pixelId             String?

  // Legacy fields (for backwards compatibility)
  buttonText          String   @default("Comprar por WhatsApp")
  buttonColor         String   @default("#25D366")
  buttonTextColor     String   @default("#FFFFFF")

  // ==========================================
  // BILLING
  // ==========================================
  plan                Plan     @default(FREE)
  ordersThisMonth     Int      @default(0)
  billingCycleStart   DateTime @default(now())
  shopifyChargeId     String?

  // ==========================================
  // MARKETING CONSENT (Shopify Partner Terms Compliance)
  // ==========================================
  marketingConsent    Boolean  @default(false)  // Merchant consents to receive marketing emails
  marketingConsentAt  DateTime?                 // When consent was given
  onboardingComplete  Boolean  @default(false)  // Has completed initial setup

  // Relations
  orders              Order[]
  formOpens           FormOpen[]
  visitors            Visitor[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Order {
  id                  String      @id @default(cuid())
  shopId              String
  shop                Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Shopify Reference
  shopifyOrderId      String?
  shopifyOrderNumber  String?

  // Customer Info
  customerName        String
  customerPhone       String
  customerEmail       String?
  customerAddress     String
  customerProvince    String
  customerCity        String?
  customerCountry     String      @default("")
  customerNotes       String?

  // Order Details
  productId           String
  productTitle        String
  productVariantId    String?
  productVariantTitle String?
  productImage        String?
  quantity            Int         @default(1)
  unitPrice           Decimal     @db.Decimal(10, 2)
  subtotal            Decimal     @db.Decimal(10, 2)
  shippingCost        Decimal     @default(0) @db.Decimal(10, 2)
  shippingRateName    String?
  codFee              Decimal     @default(0) @db.Decimal(10, 2)
  discount            Decimal     @default(0) @db.Decimal(10, 2)
  total               Decimal     @db.Decimal(10, 2)
  currency            String      @default("USD")

  // Upsells
  upsellsData         Json?       // Store upsell items if any

  // Status
  status              OrderStatus @default(PENDING)
  whatsappSent        Boolean     @default(false)
  whatsappSentAt      DateTime?

  // Metadata
  source              String      @default("cod_form")
  ipAddress           String?
  userAgent           String?

  // UTM Tracking
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  utmTerm             String?
  utmContent          String?

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([shopId, createdAt(sort: Desc)])
  @@index([shopId, status])
  @@index([customerPhone])
  @@index([shopId, utmSource, utmMedium, utmCampaign])
}

// Form Open Tracking
model FormOpen {
  id                  String      @id @default(cuid())
  shopId              String
  shop                Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Product context
  productId           String?
  productTitle        String?

  // UTM Tracking
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?

  // Metadata
  ipAddress           String?
  userAgent           String?
  pageUrl             String?

  createdAt           DateTime    @default(now())

  @@index([shopId, createdAt(sort: Desc)])
  @@index([shopId, utmSource, utmMedium, utmCampaign])
}

enum Plan {
  FREE        // 100 orders/month
  PRO         // Unlimited orders
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

// ============================================================================
// VISITOR TRACKING (Built for Shopify Requirement 5.7.2)
// ============================================================================

model Visitor {
  id                  String      @id @default(cuid())
  shopId              String
  shop                Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Session tracking
  sessionId           String
  fingerprint         String?
  ipAddress           String?
  userAgent           String?
  referrer            String?
  landingPage         String?

  // UTM Tracking
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  utmTerm             String?
  utmContent          String?

  // Customer identification (when form is submitted)
  phone               String?
  email               String?
  customerName        String?
  shopifyCustomerId   String?     // Numeric Shopify customer ID
  shopifyCustomerGid  String?     // Full Shopify GID

  // Conversion tracking
  orderId             String?     // Link to converted order

  // Timestamps
  firstSeen           DateTime    @default(now())
  lastSeen            DateTime    @default(now())
  identifiedAt        DateTime?   // When customer was identified
  convertedAt         DateTime?   // When order was placed

  // Relations
  activities          VisitorActivity[]

  @@index([shopId, sessionId])
  @@index([shopId, firstSeen(sort: Desc)])
  @@index([shopId, phone])
  @@index([shopId, email])
  @@index([shopifyCustomerId])
}

model VisitorActivity {
  id                  String      @id @default(cuid())
  visitorId           String
  visitor             Visitor     @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  event               String      // form_open, field_focus, field_blur, submit_attempt, etc.
  metadata            String?     // JSON string of additional data

  createdAt           DateTime    @default(now())

  @@index([visitorId, createdAt(sort: Desc)])
}
