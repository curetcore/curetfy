// Curetfy - COD Form
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Shopify Session Storage (required by shopify-app-remix)
model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@index([shop])
}

// Shop Configuration
model Shop {
  id                  String   @id @default(cuid())
  shopDomain          String   @unique

  // ==========================================
  // WHATSAPP CONFIGURATION
  // ==========================================
  whatsappNumber      String?
  messageTemplate     String?  @default("ðŸ›’ *Nuevo Pedido #{{orderNumber}}*\n\n{{#products}}*Producto:* {{title}}\n*Cantidad:* {{quantity}}\n*Precio:* {{price}}\n{{/products}}\n*Total:* {{total}}\n\n*Cliente:* {{name}}\n*TelÃ©fono:* {{phone}}\n*DirecciÃ³n:* {{address}}\n*Ciudad:* {{city}}\n*Provincia:* {{province}}")

  // ==========================================
  // SHOPIFY ORDER CONFIGURATION
  // ==========================================
  orderTagPrefix      String   @default("cod-form")
  orderTags           String[] @default(["pago-contraentrega", "curetfy"])
  createDraftOrder    Boolean  @default(true)
  orderNote           String?  @default("Pedido creado via Curetfy COD Form")

  // ==========================================
  // ORDER OPTIONS
  // ==========================================
  useCodPaymentMethod     Boolean  @default(true)   // Create orders with COD payment method
  saveUtmParams           Boolean  @default(true)   // Save UTM params in order additional details

  // ==========================================
  // FORM OPTIONS
  // ==========================================
  disableAutoDiscounts    Boolean  @default(false)  // Disable Shopify auto discounts in COD form
  disableAutocomplete     Boolean  @default(false)  // Disable autocomplete in COD form
  removeLeadingZeroPhone  Boolean  @default(false)  // Remove leading 0 from phone numbers
  addCodFormTag           Boolean  @default(true)   // Add curetfy_cod_form tag to orders

  // ==========================================
  // FORM LABELS (Editable)
  // ==========================================
  labelName           String   @default("Nombre completo")
  labelPhone          String   @default("TelÃ©fono / WhatsApp")
  labelEmail          String   @default("Email (opcional)")
  labelAddress        String   @default("DirecciÃ³n de entrega")
  labelCity           String   @default("Ciudad")
  labelProvince       String   @default("Provincia / Estado")
  labelPostalCode     String   @default("CÃ³digo postal")
  labelNotes          String   @default("Notas del pedido")
  labelQuantity       String   @default("Cantidad")

  // ==========================================
  // FORM PLACEHOLDERS (Editable)
  // ==========================================
  placeholderName     String   @default("Ej: Juan PÃ©rez")
  placeholderPhone    String   @default("Ej: 809-555-1234")
  placeholderEmail    String   @default("Ej: juan@email.com")
  placeholderAddress  String   @default("Calle, nÃºmero, sector...")
  placeholderCity     String   @default("Ej: Santo Domingo")
  placeholderNotes    String   @default("Instrucciones especiales...")
  placeholderPostal   String   @default("Ej: 10101")

  // ==========================================
  // FORM FIELDS VISIBILITY
  // ==========================================
  showEmail           Boolean  @default(false)
  showCity            Boolean  @default(true)
  showProvince        Boolean  @default(true)
  showPostalCode      Boolean  @default(false)
  showNotes           Boolean  @default(true)
  showQuantity        Boolean  @default(true)

  // ==========================================
  // FORM FIELDS REQUIRED
  // ==========================================
  requireEmail        Boolean  @default(false)
  requireCity         Boolean  @default(false)
  requireProvince     Boolean  @default(true)
  requirePostalCode   Boolean  @default(false)
  requireNotes        Boolean  @default(false)

  // ==========================================
  // MODAL CUSTOMIZATION
  // ==========================================
  formTitle           String   @default("Completa tu pedido")
  formSubtitle        String?  @default("Ingresa tus datos para recibir tu pedido")
  submitButtonText    String   @default("Enviar pedido por WhatsApp")
  submitButtonColor   String   @default("#25D366")
  modalHeaderColor    String   @default("#000000")
  modalAccentColor    String   @default("#25D366")
  showProductImage    Boolean  @default(true)
  showProductPrice    Boolean  @default(true)

  // ==========================================
  // FIELD ORDERING & CUSTOMIZATION
  // ==========================================
  fieldOrder          Json?    @default("[\"name\", \"phone\", \"email\", \"address\", \"city\", \"province\", \"postalCode\", \"notes\", \"quantity\"]")

  // ==========================================
  // CUSTOM FIELDS (Dynamic form builder)
  // ==========================================
  // Types: text, textarea, select, radio, checkbox, date, number, link_button, image, heading
  // Structure: [{ id, type, label, placeholder?, options?, required?, url?, imageUrl? }]
  customFields        Json?    @default("[]")

  // ==========================================
  // CUSTOM CONTENT (Images, HTML, Liquid)
  // ==========================================
  customImageUrl      String?  // Custom image URL to display
  customImagePosition String   @default("none") // none, top, bottom, after_product
  customHtmlTop       String?  // Custom HTML at top of form
  customHtmlBottom    String?  // Custom HTML at bottom of form (before submit)
  customCss           String?  // Custom CSS styles

  // ==========================================
  // MODAL OPTIONS
  // ==========================================
  hideCloseButton     Boolean  @default(false)  // Hide the X close button
  hideFieldLabels     Boolean  @default(false)  // Hide labels, show only placeholders
  enableRTL           Boolean  @default(false)  // Right-to-left support for Arabic
  fullscreenMobile    Boolean  @default(true)   // Fullscreen modal on mobile devices

  // ==========================================
  // SHIPPING RATES
  // ==========================================
  enableShipping       Boolean  @default(false)  // Enable shipping rates
  shippingSource       String   @default("custom") // "custom" or "shopify"
  customShippingRates  Json?    // Custom shipping rates: [{name, price, provinces}]

  // ==========================================
  // SUCCESS/ERROR MESSAGES
  // ==========================================
  successTitle        String   @default("Â¡Pedido enviado!")
  successMessage      String   @default("Te redirigiremos a WhatsApp para confirmar tu pedido.")
  errorTitle          String   @default("Error")
  errorMessage        String   @default("Hubo un problema al procesar tu pedido. Intenta de nuevo.")

  // ==========================================
  // COUNTRY/REGION CONFIGURATION
  // ==========================================
  countries           String[] @default(["DO"])
  defaultCountry      String   @default("DO")
  provincesConfig     Json?    // Custom provinces per country

  // ==========================================
  // PRODUCT SETTINGS
  // ==========================================
  enabledProducts     String[] @default([])
  enabledCollections  String[] @default([])
  enableAllProducts   Boolean  @default(true)

  // ==========================================
  // VISIBILITY SETTINGS
  // ==========================================
  formEnabled              Boolean  @default(true)   // Master on/off toggle
  enableOnProductPages     Boolean  @default(true)   // Show on product pages
  enableOnCartPage         Boolean  @default(false)  // Show on cart page

  // Cart page options
  hideCartBuyNowButton     Boolean  @default(false)  // Hide Buy Now in cart

  // Product page options
  productButtonAction      String   @default("current") // "current" or "current_plus_cart"
  hideAddToCartButton      Boolean  @default(false)  // Hide Add to Cart button
  hideProductBuyNowButton  Boolean  @default(false)  // Hide Buy Now on product pages

  // Other pages
  disableOnHomePage        Boolean  @default(false)  // Disable on home page
  disableOnCollectionPages Boolean  @default(false)  // Disable on collection pages

  // ==========================================
  // ADVANCED SETTINGS
  // ==========================================
  autoRedirectWhatsApp Boolean @default(true)
  redirectDelay       Int      @default(2000) // milliseconds
  enableAnalytics     Boolean  @default(true)
  enablePixel         Boolean  @default(false)
  pixelId             String?

  // Legacy fields (for backwards compatibility)
  buttonText          String   @default("Comprar por WhatsApp")
  buttonColor         String   @default("#25D366")
  buttonTextColor     String   @default("#FFFFFF")

  // ==========================================
  // BILLING
  // ==========================================
  plan                Plan     @default(FREE)
  ordersThisMonth     Int      @default(0)
  billingCycleStart   DateTime @default(now())
  shopifyChargeId     String?

  // Relations
  orders              Order[]
  formOpens           FormOpen[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Order {
  id                  String      @id @default(cuid())
  shopId              String
  shop                Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Shopify Reference
  shopifyOrderId      String?
  shopifyOrderNumber  String?

  // Customer Info
  customerName        String
  customerPhone       String
  customerEmail       String?
  customerAddress     String
  customerProvince    String
  customerCity        String?
  customerCountry     String      @default("DO")
  customerNotes       String?

  // Order Details
  productId           String
  productTitle        String
  productVariantId    String?
  productImage        String?
  quantity            Int         @default(1)
  unitPrice           Decimal     @db.Decimal(10, 2)
  subtotal            Decimal     @db.Decimal(10, 2)
  discount            Decimal     @default(0) @db.Decimal(10, 2)
  total               Decimal     @db.Decimal(10, 2)
  currency            String      @default("DOP")

  // Upsells
  upsellsData         Json?       // Store upsell items if any

  // Status
  status              OrderStatus @default(PENDING)
  whatsappSent        Boolean     @default(false)
  whatsappSentAt      DateTime?

  // Metadata
  source              String      @default("cod_form")
  ipAddress           String?
  userAgent           String?

  // UTM Tracking
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  utmTerm             String?
  utmContent          String?

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([shopId, createdAt(sort: Desc)])
  @@index([shopId, status])
  @@index([customerPhone])
  @@index([shopId, utmSource, utmMedium, utmCampaign])
}

// Form Open Tracking
model FormOpen {
  id                  String      @id @default(cuid())
  shopId              String
  shop                Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Product context
  productId           String?
  productTitle        String?

  // UTM Tracking
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?

  // Metadata
  ipAddress           String?
  userAgent           String?
  pageUrl             String?

  createdAt           DateTime    @default(now())

  @@index([shopId, createdAt(sort: Desc)])
  @@index([shopId, utmSource, utmMedium, utmCampaign])
}

enum Plan {
  FREE        // 60 orders/month
  PRO         // 500 orders/month
  BUSINESS    // 2000 orders/month
  UNLIMITED   // Unlimited
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}
